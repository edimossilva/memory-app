version: v1.0
name: Docker-compose tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "rspec 1"
    dependencies: []
    task:
      jobs:
        - name: rspec 1
          commands:
            - checkout
            - docker-compose build
            - docker-compose up -d
            - "docker-compose exec memory_app_back rake db:create"
            - "docker-compose exec memory_app_back rake db:migrate"
            - docker-compose exec memory_app_back rspec spec/models/user_spec.rb
            - artifact push workflow app/coverage/.resultset.json -d result_1.json
  - name: "rspec 2"
    dependencies: []
    task:
      jobs:
        - name: rspec 2
          commands:
            - checkout
            - docker-compose build
            - docker-compose up -d
            - "docker-compose exec memory_app_back rake db:create"
            - "docker-compose exec memory_app_back rake db:migrate"
            - docker-compose exec memory_app_back rspec spec/models/memory_spec.rb
            - artifact push workflow app/coverage/.resultset.json -d result_2.json
  - name: merge tests
    dependencies: ["rspec 1", "rspec 2"]
    task:
      jobs:
        - name: merge tests
          commands:
            - checkout
            - gem install simplecov json
            - artifact pull workflow result_1.json -d collect_coverage/input/resultset-1.json
            - artifact pull workflow result_2.json -d collect_coverage/input/resultset-2.json
            - cd collect_coverage
            - ruby simple_cov_merger.rb
